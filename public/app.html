<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airlytics - Indian Cities Air Pollution Tracker</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles/common.css?v=1">
    <link rel="stylesheet" href="styles/main.css?v=1">
</head>
<body>
    <!-- Skip to content link for accessibility -->
    <a href="#mainTabs" class="visually-hidden-focusable">Skip to main content</a>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="bi bi-wind me-2"></i> 
                <div>
                    <div class="brand-name">AIRLYTICS</div>
                    <small class="text-muted d-block fs-6">Pollution Tracker</small>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">
                            <i class="bi bi-info-circle me-1"></i> About
                        </a>
                    </li>
                    <li class="nav-item" id="userProfileSection">
                        <!-- Will be populated by JavaScript -->
                    </li>
                    <li class="nav-item">
                        <button id="darkModeToggle" class="btn btn-outline-light ms-2" aria-label="Toggle dark mode">
                            <i class="bi bi-moon-stars"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section text-center">
        <div class="container">
            <div class="animate__animated animate__fadeIn">
                <h1 class="brand-name">AIRLYTICS</h1>
                <h1 class="display-4 fw-bold mb-4">Indian Cities Air Pollution Tracker</h1>
                <p class="lead mb-4">Real-time air quality monitoring and analysis for major Indian cities</p>
                <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#registerModal">
                        <i class="bi bi-rocket-takeoff me-2"></i>Get Started
                    </button>
                    <button class="btn btn-outline-light btn-lg" onclick="document.getElementById('tracker-tab').click()">
                        <i class="bi bi-geo-alt me-2"></i>View Cities
                    </button>
                </div>
            </div>
            
            <!-- Stats Section -->
            <div class="row mt-5 pt-4">
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-box animate__animated animate__fadeInUp animate__delay-1s">
                        <i class="bi bi-geo-alt-fill text-primary"></i>
                        <h3 id="cityCount">--</h3>
                        <p>Major Cities</p>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-box animate__animated animate__fadeInUp animate__delay-2s">
                        <i class="bi bi-graph-up text-success"></i>
                        <h3>24/7</h3>
                        <p>Real-time Data</p>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-box animate__animated animate__fadeInUp animate__delay-3s">
                        <i class="bi bi-bell text-warning"></i>
                        <h3>AQI</h3>
                        <p>Alerts</p>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="stat-box animate__animated animate__fadeInUp animate__delay-4s">
                        <i class="bi bi-file-earmark-text text-info"></i>
                        <h3>PDF</h3>
                        <p>Reports</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Actions Section -->
    <section class="py-4 bg-light">
        <div class="container">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="card action-card h-100" onclick="document.getElementById('tracker-tab').click()">
                        <div class="card-body d-flex align-items-center">
                            <div class="action-icon bg-primary bg-opacity-10 text-primary rounded-circle p-3 me-3">
                                <i class="bi bi-geo-alt fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-1">Track Pollution</h5>
                                <p class="card-text small text-muted mb-0">Monitor air quality in your city</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card action-card h-100" onclick="document.getElementById('map-tab').click()">
                        <div class="card-body d-flex align-items-center">
                            <div class="action-icon bg-success bg-opacity-10 text-success rounded-circle p-3 me-3">
                                <i class="bi bi-map fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-1">Map View</h5>
                                <p class="card-text small text-muted mb-0">Visualize pollution on map</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card action-card h-100" onclick="document.getElementById('analysis-tab').click()">
                        <div class="card-body d-flex align-items-center">
                            <div class="action-icon bg-warning bg-opacity-10 text-warning rounded-circle p-3 me-3">
                                <i class="bi bi-graph-up fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-1">Analysis</h5>
                                <p class="card-text small text-muted mb-0">Detailed insights and trends</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content with Tabs -->
    <section class="py-5">
        <div class="container">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs justify-content-center mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tracker-tab" data-bs-toggle="tab" data-bs-target="#tracker" type="button" role="tab" aria-controls="tracker" aria-selected="true">
                        <i class="bi bi-geo-alt me-2"></i>Pollution Tracker
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#mapTab" type="button" role="tab" aria-controls="mapTab" aria-selected="false">
                        <i class="bi bi-map me-2"></i>Map View
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab" aria-controls="analysis" aria-selected="false">
                        <i class="bi bi-graph-up me-2"></i>Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="health-tab" data-bs-toggle="tab" data-bs-target="#health" type="button" role="tab" aria-controls="health" aria-selected="false">
                        <i class="bi bi-heart-pulse me-2"></i>Health Tips
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabsContent">
                <!-- Tracker Tab -->
                <div class="tab-pane fade show active" id="tracker" role="tabpanel" aria-labelledby="tracker-tab">
                    <div class="row justify-content-center mb-4">
                        <div class="col-md-8 text-center">
                            <p class="text-muted">Your tracked cities</p>
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="addRandomCity()">
                                    <i class="bi bi-plus-circle me-1"></i> Add Random City
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="refreshAllCitiesData()">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh Data
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="clearAllCities()">
                                    <i class="bi bi-trash me-1"></i> Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Cities Container with Enhanced Scroll -->
                    <div class="cities-container" id="citiesContainer">
                        <div class="city-grid" id="pollutionCards">
                            <!-- Cards will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="last-updated" id="lastUpdated">
                        Last updated: <span id="updateTime">--:--:--</span>
                    </div>
                </div>

                <!-- Map Tab -->
                <div class="tab-pane fade" id="mapTab" role="tabpanel" aria-labelledby="map-tab">
                    <div class="position-relative">
                        <div id="map"></div>
                        <div class="map-controls">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Search Location</h6>
                                    <div class="input-group">
                                        <input type="text" id="mapLocationInput" class="form-control" placeholder="Enter city name..." aria-label="Search for a city">
                                        <button class="btn btn-primary" onclick="searchMapLocation()">Search</button>
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-muted">Click anywhere on the map to add a city to your tracker</small>
                                    </div>
                                    <hr>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="heatmapToggle" checked>
                                        <label class="form-check-label" for="heatmapToggle">
                                            Show Pollution Heatmap
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="loading-spinner" id="mapLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Tab -->
                <div class="tab-pane fade" id="analysis" role="tabpanel" aria-labelledby="analysis-tab">
                    <div id="cityAnalysisHeader" class="city-analysis-header">
                        <h3 id="analysisCityName">City Analysis</h3>
                        <button class="back-to-all-btn" onclick="showAllCitiesAnalysis()">← Back to All Cities</button>
                    </div>
                    
                    <!-- Health Impact Indicators -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="mb-3">Health Impact Indicators</h4>
                            <div id="healthImpactCard" class="health-card health-moderate">
                                <h5 id="healthTitle">Today's air is Moderate - Sensitive people should consider reducing prolonged outdoor exertion.</h5>
                                <p id="healthDescription">Air quality is acceptable for most people. However, there may be a risk for some people, particularly those who are unusually sensitive to air pollution.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Forecast / Prediction -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="mb-3">3-Day Weather Forecast</h4>
                            <div class="card">
                                <div class="card-body">
                                    <div class="row" id="forecastContainer">
                                        <!-- Forecast cards will be populated by JavaScript -->
                                    </div>
                                    <div id="forecastChartContainer" class="chart-container mt-3">
                                        <canvas id="forecastChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Pollutant Insights -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="mb-3">Detailed Pollutant Insights</h4>
                            <div id="pollutantInsightsContainer">
                                <div id="singleCityPollutants" style="display: none;">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>Pollutant Concentration</h5>
                                            <div class="chart-container">
                                                <canvas id="cityPollutantChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="allCitiesPollutants">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6>PM2.5 Trends</h6>
                                                    <div class="mini-chart-container">
                                                        <canvas id="pm25Chart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6>PM10 Trends</h6>
                                                    <div class="mini-chart-container">
                                                        <canvas id="pm10Chart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6>NO₂ Trends</h6>
                                                    <div class="mini-chart-container">
                                                        <canvas id="no2Chart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6>O₃ Trends</h6>
                                                    <div class="mini-chart-container">
                                                        <canvas id="o3Chart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- City Comparison Enhancements -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="mb-3">City Comparison</h4>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-5">
                                            <select id="city1Select" class="form-select" aria-label="Select first city">
                                                <option value="">Select first city</option>
                                            </select>
                                        </div>
                                        <div class="col-md-5">
                                            <select id="city2Select" class="form-select" aria-label="Select second city">
                                                <option value="">Select second city</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-primary w-100" onclick="compareCities()">Compare</button>
                                        </div>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="cityComparisonChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div id="mostPollutedCard" class="highlight-box most-polluted">
                                        <h5>Most Polluted City Today</h5>
                                        <h3 id="mostPollutedCity">--</h3>
                                        <p>AQI: <span id="mostPollutedAQI">--</span></p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div id="leastPollutedCard" class="highlight-box least-polluted">
                                        <h5>Least Polluted City Today</h5>
                                        <h3 id="leastPollutedCity">--</h3>
                                        <p>AQI: <span id="leastPollutedAQI">--</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Extra Environmental Data -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="mb-3">Environmental Data</h4>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Current Weather Conditions</h5>
                                            <div class="weather-card">
                                                <i class="bi bi-thermometer-half weather-icon text-danger"></i>
                                                <div>
                                                    <h6>Temperature</h6>
                                                    <p id="temperature">--°C</p>
                                                </div>
                                            </div>
                                            <div class="weather-card">
                                                <i class="bi bi-droplet weather-icon text-primary"></i>
                                                <div>
                                                    <h6>Humidity</h6>
                                                    <p id="humidity">--%</p>
                                                </div>
                                            </div>
                                            <div class="weather-card">
                                                <i class="bi bi-wind weather-icon text-success"></i>
                                                <div>
                                                    <h6>Wind Speed</h6>
                                                    <p id="windSpeed">-- km/h</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Pollution-Weather Correlation</h5>
                                            <div class="chart-container">
                                                <canvas id="correlationChart"></canvas>
                                            </div>
                                            <p class="mt-2"><strong>Insight:</strong> Higher humidity increases PM2.5 levels.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User-Friendly Additions -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="mb-3">Additional Features</h4>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Historical Timeline</h5>
                                    <input type="range" class="form-range timeline-slider" id="timelineSlider" min="1" max="12" value="6">
                                    <div class="d-flex justify-content-between">
                                        <span>Jan</span>
                                        <span>Feb</span>
                                        <span>Mar</span>
                                        <span>Apr</span>
                                        <span>May</span>
                                        <span>Jun</span>
                                        <span>Jul</span>
                                        <span>Aug</span>
                                        <span>Sep</span>
                                        <span>Oct</span>
                                        <span>Nov</span>
                                        <span>Dec</span>
                                    </div>
                                    <div class="chart-container mt-3">
                                        <canvas id="timelineChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Download Report</h5>
                                            <p>Download a comprehensive report of current air quality analysis.</p>
                                            <button class="btn btn-primary" onclick="downloadReport()">
                                                <i class="bi bi-download me-2"></i>Download PDF
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">AQI Alerts</h5>
                                            <div id="aqiAlert" class="alert-card alert-warning">
                                                <i class="bi bi-exclamation-triangle me-2"></i>
                                                <span id="alertText">Your city AQI crossed 150 (Unhealthy).</span>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="alertToggle" checked>
                                                <label class="form-check-label" for="alertToggle">Enable AQI alerts</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Health Tips Tab -->
                <div class="tab-pane fade" id="health" role="tabpanel" aria-labelledby="health-tab">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="mb-3">Health Recommendations by AQI Level</h4>
                            <div class="accordion" id="healthAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingGood">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGood" aria-expanded="true" aria-controls="collapseGood">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-good text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">0-50</span>
                                                Good (Green)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseGood" class="accordion-collapse collapse show" aria-labelledby="headingGood" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Air quality is satisfactory, and air pollution poses little or no risk.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Enjoy outdoor activities</li>
                                                <li>Open windows to allow fresh air circulation</li>
                                                <li>Ideal for outdoor exercise and activities</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingModerate">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseModerate" aria-expanded="false" aria-controls="collapseModerate">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-moderate text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">51-100</span>
                                                Moderate (Yellow)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseModerate" class="accordion-collapse collapse" aria-labelledby="headingModerate" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Air quality is acceptable. However, there may be a risk for some people, particularly those who are unusually sensitive to air pollution.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Sensitive individuals should consider reducing prolonged outdoor exertion</li>
                                                <li>Generally acceptable for most individuals</li>
                                                <li>Monitor symptoms if you have respiratory conditions</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingUnhealthySensitive">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUnhealthySensitive" aria-expanded="false" aria-controls="collapseUnhealthySensitive">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-unhealthy-sensitive text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">101-150</span>
                                                Unhealthy for Sensitive Groups (Orange)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseUnhealthySensitive" class="accordion-collapse collapse" aria-labelledby="headingUnhealthySensitive" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Members of sensitive groups may experience health effects. The general public is less likely to be affected.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Children, elderly, and people with respiratory diseases should limit outdoor activities</li>
                                                <li>Consider wearing a mask when going outside</li>
                                                <li>Keep windows closed during peak pollution hours</li>
                                                <li>Use air purifiers indoors if available</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingUnhealthy">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUnhealthy" aria-expanded="false" aria-controls="collapseUnhealthy">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-unhealthy text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">151-200</span>
                                                Unhealthy (Red)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseUnhealthy" class="accordion-collapse collapse" aria-labelledby="headingUnhealthy" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Everyone may begin to experience health effects; members of sensitive groups may experience more serious health effects.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Limit outdoor activities</li>
                                                <li>Wear N95 masks when going outside</li>
                                                <li>Keep windows closed and use air purifiers</li>
                                                <li>Avoid strenuous outdoor exercise</li>
                                                <li>People with heart or lung disease should follow their doctors' advice</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingVeryUnhealthy">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVeryUnhealthy" aria-expanded="false" aria-controls="collapseVeryUnhealthy">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-very-unhealthy text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">201-300</span>
                                                Very Unhealthy (Purple)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseVeryUnhealthy" class="accordion-collapse collapse" aria-labelledby="headingVeryUnhealthy" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Health warnings of emergency conditions. Everyone is likely to be affected.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Avoid all outdoor activities</li>
                                                <li>Stay indoors with windows and doors closed</li>
                                                <li>Use high-efficiency air purifiers</li>
                                                <li>If you must go outside, wear a high-quality mask</li>
                                                <li>People with heart or lung disease should remain indoors and avoid physical exertion</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingHazardous">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHazardous" aria-expanded="false" aria-controls="collapseHazardous">
                                            <div class="d-flex align-items-center">
                                                <span class="aqi-badge aqi-hazardous text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">301+</span>
                                                Hazardous (Maroon)
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapseHazardous" class="accordion-collapse collapse" aria-labelledby="headingHazardous" data-bs-parent="#healthAccordion">
                                        <div class="accordion-body">
                                            <p>Health alert: everyone may experience serious health effects.</p>
                                            <h6>Recommended Actions:</h6>
                                            <ul>
                                                <li>Avoid all outdoor activities</li>
                                                <li>Remain indoors with windows and doors closed</li>
                                                <li>Use high-efficiency air purifiers</li>
                                                <li>Avoid physical exertion</li>
                                                <li>People with heart or lung disease should remain indoors and seek medical attention if symptoms worsen</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modals -->
    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel">About Airlytics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5>Air Pollution Tracker for Indian Cities</h5>
                    <p>Airlytics is a comprehensive air quality monitoring platform designed specifically for Indian cities. Our mission is to provide real-time, accurate air pollution data to help citizens make informed decisions about their daily activities and health.</p>
                    
                    <h6>Features:</h6>
                    <ul>
                        <li>Real-time AQI monitoring for major Indian cities</li>
                        <li>Interactive pollution maps</li>
                        <li>Detailed pollutant analysis</li>
                        <li>Health recommendations based on air quality</li>
                        <li>Historical data and trends</li>
                        <li>Weather correlation analysis</li>
                    </ul>
                    
                    <h6>Data Sources:</h6>
                    <p>We aggregate data from multiple reliable sources including government monitoring stations, satellite imagery, and validated crowd-sourced data to ensure accuracy and comprehensiveness.</p>
                    
                    <h6>Technology:</h6>
                    <p>Built with modern web technologies including Node.js, Express, PostgreSQL, and advanced data visualization libraries to provide a seamless user experience across devices.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Login to Airlytics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="loginEmail" aria-describedby="emailHelp" required>
                            <div id="emailHelp" class="form-text">We'll never share your email with anyone else.</div>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">Remember me</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="handleLogin(event)">Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">Create Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="registerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="registerEmail" aria-describedby="emailHelp" required>
                            <div id="emailHelp" class="form-text">We'll never share your email with anyone else.</div>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                            <div class="form-text">Password must be at least 8 characters long.</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="agreeTerms" required>
                            <label class="form-check-label" for="agreeTerms">
                                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms and Conditions</a>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="handleRegistration(event)">Register</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Terms and Conditions Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>1. Acceptance of Terms</h6>
                    <p>By accessing and using Airlytics, you accept and agree to be bound by the terms and provision of this agreement.</p>
                    
                    <h6>2. Use License</h6>
                    <p>Permission is granted to temporarily download one copy of the materials on Airlytics for personal, non-commercial transitory viewing only. This is the grant of a license, not a transfer of title, and under this license you may not:</p>
                    <ul>
                        <li>modify or copy the materials</li>
                        <li>use the materials for any commercial purpose</li>
                        <li>attempt to decompile or reverse engineer any software contained on Airlytics</li>
                        <li>remove any copyright or other proprietary notations from the materials</li>
                    </ul>
                    
                    <h6>3. Disclaimer</h6>
                    <p>The materials on Airlytics are provided on an 'as is' basis. Airlytics makes no warranties, expressed or implied, and hereby disclaims and negates all other warranties including without limitation, implied warranties or conditions of merchantability, fitness for a particular purpose, or non-infringement of intellectual property or other violation of rights.</p>
                    
                    <h6>4. Limitations</h6>
                    <p>In no event shall Airlytics or its suppliers be liable for any damages (including, without limitation, damages for loss of data or profit, or due to business interruption) arising out of the use or inability to use the materials on Airlytics, even if Airlytics or an authorized representative has been notified orally or in writing of the possibility of such damage.</p>
                    
                    <h6>5. Accuracy of Materials</h6>
                    <p>The materials appearing on Airlytics could include technical, typographical, or photographic errors. Airlytics does not warrant that any of the materials on its website are accurate, complete, or current. Airlytics may make changes to the materials contained on its website at any time without notice. However, Airlytics does not make any commitment to update the materials.</p>
                    
                    <h6>6. Links</h6>
                    <p>Airlytics has not reviewed all of the sites linked to its website and is not responsible for the contents of any such linked site. The inclusion of any link does not imply endorsement by Airlytics of the site. Use of any such linked website is at the user's own risk.</p>
                    
                    <h6>7. Modifications</h6>
                    <p>Airlytics may revise these terms of service for its website at any time without notice. By using this website you are agreeing to be bound by the then current version of these terms of service.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom JavaScript -->
    <script type="module">
        import { indianCitiesData as cities } from './data/cities.js';
        window.cities = cities;
    </script>
    <script src="scripts/pollutionTracker.js"></script>
    <script src="scripts/map.js"></script>
    <script src="js/guestFeatures.js"></script>
    <script>
        // API Configuration
        const API_BASE = ''; // Empty for same origin, or set to your deployed URL
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            const userType = localStorage.getItem('userType');
            if (!userType) {
                window.location.href = 'landing.html';
                return;
            }
            
            updateUserProfile(userType);
            setupFeatureRestrictions(userType);
        });

        // Retry function for API calls
        async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                if (retries <= 0) throw error;
                console.log(`Retrying... attempts left: ${retries}`);
                await new Promise(resolve => setTimeout(resolve, delay));
                return fetchWithRetry(url, options, retries - 1, delay * 2);
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            const notificationContainer = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show`;
            notification.setAttribute('role', 'alert');
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            notificationContainer.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 150);
            }, 3000);
        }

        // Handle login function
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const data = await fetchWithRetry(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                showNotification('Login successful!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                if (modal) modal.hide();
                
                // Update UI
                updateAuthUI();
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Network error. Please try again.', 'danger');
            }
        }

        // Handle registration function
        async function handleRegistration(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                showNotification('Passwords do not match!', 'danger');
                return;
            }
            
            try {
                const data = await fetchWithRetry(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, password })
                });
                
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                showNotification('Registration successful!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
                if (modal) modal.hide();
                
                // Update UI
                updateAuthUI();
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('Network error. Please try again.', 'danger');
            }
        }

        // Update user profile UI
        function updateUserProfile(userType) {
            const userProfileSection = document.getElementById('userProfileSection');
            const userName = userType === 'guest' ? 'Guest User' : (localStorage.getItem('userName') || 'User');
            
            userProfileSection.innerHTML = `
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i> ${userName}
                        ${userType === 'guest' ? '<span class="badge bg-warning ms-1">Guest</span>' : ''}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        ${userType === 'guest' ? `
                            <li><a class="dropdown-item text-primary" href="landing.html">
                                <i class="bi bi-person-plus me-1"></i> Register Account
                            </a></li>
                        ` : ''}
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-1"></i> Logout
                        </a></li>
                    </ul>
                </div>
            `;
        }
        
        // Set up feature restrictions for guest users
        function setupFeatureRestrictions(userType) {
            if (userType === 'guest') {
                // Disable map location adding
                const mapControls = document.querySelector('.map-controls');
                if (mapControls) {
                    mapControls.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Map Features Limited</h6>
                                <p class="small text-muted mb-0">Please <a href="landing.html">register</a> to add custom locations</p>
                            </div>
                        </div>
                    `;
                }
                
                // Disable analysis features
                const analysisTab = document.getElementById('analysis-tab');
                if (analysisTab) {
                    analysisTab.classList.add('disabled');
                    analysisTab.setAttribute('title', 'Register to access detailed analysis');
                }
                
                // Add warning banner
                const mainTabsContent = document.getElementById('mainTabsContent');
                if (mainTabsContent) {
                    const warningBanner = document.createElement('div');
                    warningBanner.className = 'alert alert-warning alert-dismissible fade show mb-3';
                    warningBanner.innerHTML = `
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        You are using a guest account with limited features. 
                        <a href="landing.html" class="alert-link">Register now</a> to access all features.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    mainTabsContent.prepend(warningBanner);
                }
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('userType');
            localStorage.removeItem('userName');
            window.location.href = 'landing.html';
        }

        // Map functionality
        let map;
        let markers = [];

        // Initialize map when the map tab is clicked
        document.getElementById('map-tab').addEventListener('shown.bs.tab', function () {
            if (!map) {
                initializeMap();
            }
        });

        function initializeMap() {
            // Initialize the map
            map = L.map('map').setView([20.5937, 78.9629], 5); // Center of India

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add markers for all cities
            window.cities.forEach(city => {
                const aqiColor = getAQIColor(city.aqi);
                const marker = L.circleMarker([city.lat, city.lon], {
                    radius: 8,
                    fillColor: aqiColor,
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                // Create popup content
                const popupContent = `
                    <div class="map-popup">
                        <h6>${city.name}</h6>
                        <p class="mb-1">AQI: <strong style="color: ${aqiColor}">${city.aqi}</strong></p>
                        <button class="btn btn-sm btn-primary" onclick="addCityFromMap('${city.name}')">
                            Add to Tracker
                        </button>
                    </div>
                `;

                // Add popup to marker
                marker.bindPopup(popupContent);
                markers.push(marker);
            });

            // Hide loading spinner
            document.getElementById('mapLoading').style.display = 'none';
        }

        function getAQIColor(aqi) {
            if (aqi <= 50) return '#198754';  // Good - Green
            if (aqi <= 100) return '#ffc107'; // Moderate - Yellow
            if (aqi <= 150) return '#fd7e14'; // Unhealthy for Sensitive Groups - Orange
            if (aqi <= 200) return '#dc3545'; // Unhealthy - Red
            if (aqi <= 300) return '#6f42c1'; // Very Unhealthy - Purple
            return '#721c24';                 // Hazardous - Maroon
        }

        function addCityFromMap(cityName) {
            const city = window.cities.find(c => c.name === cityName);
            if (city && !trackedCities.some(tc => tc.name === cityName)) {
                trackedCities.push(city);
                addCityCard(city);
                showNotification(`Added ${cityName} to tracker!`, 'success');
                updateLastUpdatedTime();
            } else if (trackedCities.some(tc => tc.name === cityName)) {
                showNotification(`${cityName} is already being tracked!`, 'warning');
            }
        }

        function searchMapLocation() {
            const location = document.getElementById('mapLocationInput').value;
            if (location) {
                showNotification(`Searching for ${location}...`, 'info');
                
                // For demo purposes, just add a marker at a fixed location
                // In a real app, you would use a geocoding service
                const demoLocations = {
                    'delhi': [28.7041, 77.1025],
                    'mumbai': [19.0760, 72.8777],
                    'bangalore': [12.9716, 77.5946],
                    'kolkata': [22.5726, 88.3639],
                    'chennai': [13.0827, 80.2707]
                };
                
                const locationKey = location.toLowerCase();
                if (demoLocations[locationKey]) {
                    const [lat, lng] = demoLocations[locationKey];
                    map.setView([lat, lng], 10);
                    addCityMarker(lat, lng);
                    showNotification(`Found ${location}!`, 'success');
                } else {
                    showNotification(`Location "${location}" not found. Try Delhi, Mumbai, Bangalore, Kolkata, or Chennai.`, 'warning');
                }
            }
        }

        // Pollution tracker functionality
        let trackedCities = [];

        function addRandomCity() {
            // Filter out cities that are already being tracked
            const availableCities = window.cities.filter(city => 
                !trackedCities.some(tracked => tracked.name === city.name)
            );
            
            if (availableCities.length === 0) {
                showNotification('All cities are already being tracked!', 'warning');
                return;
            }
            
            const randomCity = availableCities[Math.floor(Math.random() * availableCities.length)];
            trackedCities.push(randomCity);
            
            addCityCard(randomCity);
            showNotification(`Added ${randomCity.name} to tracker!`, 'success');
            updateLastUpdatedTime();
        }

        function addCityCard(city) {
            const pollutionCards = document.getElementById('pollutionCards');
            const card = document.createElement('div');
            card.className = 'card city-card h-100';
            card.id = `city-${city.name.replace(/\s+/g, '-').toLowerCase()}`;
            
            // Determine AQI status and color
            let aqiStatus, aqiClass;
            if (city.aqi <= 50) {
                aqiStatus = 'Good';
                aqiClass = 'aqi-good';
            } else if (city.aqi <= 100) {
                aqiStatus = 'Moderate';
                aqiClass = 'aqi-moderate';
            } else if (city.aqi <= 150) {
                aqiStatus = 'Unhealthy for Sensitive Groups';
                aqiClass = 'aqi-unhealthy-sensitive';
            } else if (city.aqi <= 200) {
                aqiStatus = 'Unhealthy';
                aqiClass = 'aqi-unhealthy';
            } else if (city.aqi <= 300) {
                aqiStatus = 'Very Unhealthy';
                aqiClass = 'aqi-very-unhealthy';
            } else {
                aqiStatus = 'Hazardous';
                aqiClass = 'aqi-hazardous';
            }
            
            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">${city.name}</h5>
                        <div class="aqi-badge ${aqiClass} text-white">${city.aqi}</div>
                    </div>
                    <p class="card-text"><strong>Status:</strong> ${aqiStatus}</p>
                    <p class="card-text"><strong>PM2.5:</strong> ${city.pm25} µg/m³</p>
                    <p class="card-text"><strong>PM10:</strong> ${city.pm10} µg/m³</p>
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="refreshCityData('${city.name}')">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-primary flex-grow-1" onclick="viewCityAnalysis('${city.name}')">
                            <i class="bi bi-graph-up me-1"></i> Analysis
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeCity('${city.name}')">
                            <i class="bi bi-trash me-1"></i>
                        </button>
                    </div>
                </div>
            `;
            
            pollutionCards.appendChild(card);
        }

        // Global refresh state
        let isRefreshing = false;
        let lastRefreshTime = null;
        
        async function refreshCityData(cityName) {
            if (isRefreshing) {
                showNotification('Data refresh already in progress...', 'info');
                return;
            }
            
            const cityIndex = trackedCities.findIndex(city => city.name === cityName);
            if (cityIndex !== -1) {
                try {
                    isRefreshing = true;
                    showNotification(`Refreshing data for ${cityName}...`, 'info');
                    
                    // Get fresh data from API
                    const response = await fetch(`/api/pollution/latest?city=${encodeURIComponent(cityName)}`, {
                        headers: getRequestHeaders()
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch updated data');
                    
                    const data = await response.json();
                    trackedCities[cityIndex] = {
                        ...trackedCities[cityIndex],
                        ...data.latestReading
                    };
                    
                    // Update the card
                    const cardId = `city-${cityName.replace(/\s+/g, '-').toLowerCase()}`;
                    const card = document.getElementById(cardId);
                    if (card) {
                        card.remove();
                        addCityCard(trackedCities[cityIndex]);
                    }
                    
                    showNotification(`Refreshed data for ${cityName}!`, 'success');
                    lastRefreshTime = new Date();
                    updateLastUpdatedTime();
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    showNotification(`Failed to refresh data for ${cityName}`, 'error');
                } finally {
                    isRefreshing = false;
                }
            }
        }

        function removeCity(cityName) {
            trackedCities = trackedCities.filter(city => city.name !== cityName);
            
            const cardId = `city-${cityName.replace(/\s+/g, '-').toLowerCase()}`;
            const card = document.getElementById(cardId);
            if (card) {
                card.remove();
            }
            
            showNotification(`Removed ${cityName} from tracker!`, 'info');
        }

        async function refreshAllCitiesData() {
            if (trackedCities.length === 0) {
                showNotification('No cities to refresh!', 'warning');
                return;
            }
            
            if (isRefreshing) {
                showNotification('Data refresh already in progress...', 'info');
                return;
            }
            
            try {
                isRefreshing = true;
                showNotification('Refreshing all city data...', 'info');
                
                // Clear all cards
                document.getElementById('pollutionCards').innerHTML = '';
                
                // Refresh all cities and add new cards
                const cityNames = trackedCities.map(city => city.name);
                const refreshPromises = cityNames.map(async (cityName) => {
                    try {
                        const response = await fetch(`/api/pollution/latest?city=${encodeURIComponent(cityName)}`, {
                            headers: getRequestHeaders()
                        });
                        
                        if (!response.ok) throw new Error(`Failed to fetch data for ${cityName}`);
                        
                        const data = await response.json();
                        return {
                            name: cityName,
                            ...data.latestReading
                        };
                    } catch (error) {
                        console.error(`Error refreshing ${cityName}:`, error);
                        return null;
                    }
                });
                
                const refreshedCities = await Promise.all(refreshPromises);
                trackedCities = refreshedCities.filter(city => city !== null);
                
                // Add cards for successfully refreshed cities
                trackedCities.forEach(city => addCityCard(city));
                
                lastRefreshTime = new Date();
                updateLastUpdatedTime();
                showNotification('All city data refreshed!', 'success');
                
                // Update analysis if on analysis tab
                if (document.getElementById('analysis').classList.contains('active')) {
                    updateAnalysisData();
                }
            } catch (error) {
                console.error('Error refreshing all cities:', error);
                showNotification('Failed to refresh some city data', 'error');
            } finally {
                isRefreshing = false;
            }
        }

        function clearAllCities() {
            if (trackedCities.length === 0) {
                showNotification('No cities to clear!', 'warning');
                return;
            }
            
            if (confirm('Are you sure you want to remove all tracked cities?')) {
                trackedCities = [];
                document.getElementById('pollutionCards').innerHTML = '';
                showNotification('All cities removed!', 'warning');
            }
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('updateTime').textContent = timeString;
        }

        // Placeholder functions for features
        function compareCities() {
            const city1 = document.getElementById('city1Select').value;
            const city2 = document.getElementById('city2Select').value;
            if (city1 && city2) {
                showNotification(`Comparing ${city1} and ${city2}...`, 'info');
            } else {
                showNotification('Please select two cities to compare', 'warning');
            }
        }

        // Store active charts for cleanup
        let activeCharts = {};
        
        async function viewCityAnalysis(cityName) {
            try {
                // Switch to analysis tab
                document.getElementById('analysis-tab').click();
                
                // Show loading state
                showNotification(`Loading analysis for ${cityName}...`, 'info');
                
                // Get fresh data for the city
                const response = await fetch(`/api/pollution/latest?city=${encodeURIComponent(cityName)}`, {
                    headers: getRequestHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to fetch city data');
                
                const { latestReading: city } = await response.json();
                
                // Update city name in analysis view
                document.getElementById('analysisCityName').textContent = `${cityName} Analysis`;
                
                // Show single city analysis view, hide all cities view
                document.getElementById('singleCityPollutants').style.display = 'block';
                document.getElementById('allCitiesPollutants').style.display = 'none';
                
                // Update health impact card
                updateHealthImpact(city.aqi);
                
                // Get weather data for the city
                try {
                    const weatherResponse = await fetch(`/api/weather?city=${encodeURIComponent(cityName)}`, {
                        headers: getRequestHeaders()
                    });
                    
                    if (weatherResponse.ok) {
                        const weatherData = await weatherResponse.json();
                        document.getElementById('temperature').textContent = `${weatherData.temperature}°C`;
                        document.getElementById('humidity').textContent = `${weatherData.humidity}%`;
                        document.getElementById('windSpeed').textContent = `${weatherData.windSpeed} km/h`;
                    }
                } catch (error) {
                    console.error('Error fetching weather data:', error);
                    // Use placeholder data if weather fetch fails
                    document.getElementById('temperature').textContent = `${Math.round(20 + Math.random() * 15)}°C`;
                    document.getElementById('humidity').textContent = `${Math.round(40 + Math.random() * 40)}%`;
                    document.getElementById('windSpeed').textContent = `${Math.round(5 + Math.random() * 20)} km/h`;
                }
                
                // Cleanup old chart if exists
                if (activeCharts.pollutant) {
                    activeCharts.pollutant.destroy();
                }
                
                // Update pollutant chart
                const ctx = document.getElementById('cityPollutantChart').getContext('2d');
                activeCharts.pollutant = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['PM2.5', 'PM10', 'NO2', 'SO2', 'CO', 'O3'],
                        datasets: [{
                            label: 'Concentration',
                            data: [city.pm25, city.pm10, city.no2, city.so2, city.co, city.o3],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.5)',
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(153, 102, 255, 0.5)',
                                'rgba(255, 159, 64, 0.5)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                // Start auto-update for analysis
                startAnalysisAutoUpdate(cityName);
                
                showNotification(`Analysis loaded for ${cityName}`, 'success');
            } catch (error) {
                console.error('Error loading city analysis:', error);
                showNotification(`Failed to load analysis for ${cityName}`, 'error');
            }
        }
        
        // Auto-update for analysis
        let analysisUpdateInterval;
        
        function startAnalysisAutoUpdate(cityName) {
            // Clear any existing interval
            if (analysisUpdateInterval) {
                clearInterval(analysisUpdateInterval);
            }
            
            // Update every 5 minutes
            analysisUpdateInterval = setInterval(() => {
                if (document.getElementById('analysis').classList.contains('active')) {
                    viewCityAnalysis(cityName);
                }
            }, 300000); // 5 minutes
        }
        
        // Cleanup on tab change
        document.getElementById('mainTabs').addEventListener('shown.bs.tab', function (e) {
            if (e.target.id !== 'analysis-tab' && analysisUpdateInterval) {
                clearInterval(analysisUpdateInterval);
            }
        });

        function updateHealthImpact(aqi) {
            const healthCard = document.getElementById('healthImpactCard');
            const healthTitle = document.getElementById('healthTitle');
            const healthDescription = document.getElementById('healthDescription');
            
            if (aqi <= 50) {
                healthCard.className = 'health-card health-good';
                healthTitle.textContent = 'Air quality is Good';
                healthDescription.textContent = 'Air quality is satisfactory, and air pollution poses little or no risk.';
            } else if (aqi <= 100) {
                healthCard.className = 'health-card health-moderate';
                healthTitle.textContent = 'Air quality is Moderate';
                healthDescription.textContent = 'Air quality is acceptable. However, there may be a risk for some people, particularly those who are unusually sensitive to air pollution.';
            } else if (aqi <= 150) {
                healthCard.className = 'health-card health-unhealthy-sensitive';
                healthTitle.textContent = 'Unhealthy for Sensitive Groups';
                healthDescription.textContent = 'Members of sensitive groups may experience health effects. The general public is less likely to be affected.';
            } else if (aqi <= 200) {
                healthCard.className = 'health-card health-unhealthy';
                healthTitle.textContent = 'Air quality is Unhealthy';
                healthDescription.textContent = 'Some members of the general public may experience health effects; members of sensitive groups may experience more serious health effects.';
            } else if (aqi <= 300) {
                healthCard.className = 'health-card health-very-unhealthy';
                healthTitle.textContent = 'Air quality is Very Unhealthy';
                healthDescription.textContent = 'Health alert: The risk of health effects is increased for everyone.';
            } else {
                healthCard.className = 'health-card health-hazardous';
                healthTitle.textContent = 'Air quality is Hazardous';
                healthDescription.textContent = 'Health warning of emergency conditions: everyone is more likely to be affected.';
            }
        }

        function showAllCitiesAnalysis() {
            document.getElementById('analysisCityName').textContent = 'All Cities Analysis';
            document.getElementById('singleCityPollutants').style.display = 'none';
            document.getElementById('allCitiesPollutants').style.display = 'block';
            showNotification('Showing all cities analysis', 'info');
        }

        function downloadReport() {
            showNotification('Preparing your report...', 'info');
            setTimeout(() => {
                showNotification('Report downloaded successfully!', 'success');
            }, 2000);
        }

        // Update city count
        function updateCityCount() {
            const cityCountElement = document.getElementById('cityCount');
            if (cityCountElement && window.cities) {
                cityCountElement.textContent = `${window.cities.length}+`;
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Update city count
            updateCityCount();
            
            // Add event listeners for forms
            const loginForm = document.querySelector('#loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            const registerForm = document.querySelector('#registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', handleRegistration);
            }
            
            // Update UI on page load
            updateAuthUI();
            
            // Dark mode toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const icon = darkModeToggle.querySelector('i');
                    if (document.body.classList.contains('dark-mode')) {
                        icon.classList.remove('bi-moon-stars');
                        icon.classList.add('bi-sun');
                    } else {
                        icon.classList.remove('bi-sun');
                        icon.classList.add('bi-moon-stars');
                    }
                });
            }
        });
    </script>
</body>
</html>